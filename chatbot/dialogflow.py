from datetime import datetime
from django.urls import reverse
from wiki.models import WikiPage
import re


def get_dialogflow_response(user_input):
    text = (user_input or '').strip()
    lower = text.lower()

    # UUID λ…λ Ήμ€ viewsμ—μ„ μ²λ¦¬ν•λ―€λ΅ μ—¬κΈ°μ„λ” μ•λ‚΄λ§
    if lower.startswith('uuid '):
        return 'λ‹‰λ„¤μ„μ UUID μ •λ³΄λ¥Ό μ΅°νν•©λ‹λ‹¤...'

    # μΈμ‚¬λ§
    if any(g in lower for g in ['μ•λ…•', 'hello', 'hi']):
        return 'μ•λ…•ν•μ„Έμ”! λ§μΈν¬λν”„νΈ κ΄€λ ¨ μ§λ¬Έμ΄ μμΌμ‹λ©΄ μ–Έμ λ“  λ¬Όμ–΄λ³΄μ„Έμ”!'

    # μ‹κ°„ κ΄€λ ¨
    if 'μ‹κ°„' in text or 'λ‡μ‹' in text:
        return f"μ§€κΈ μ‹κ°„μ€ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} μ…λ‹λ‹¤."

    # μ„ν‚¤ κ²€μƒ‰ κΈ°λ¥
    wiki_response = search_wiki_content(text)
    if wiki_response:
        return wiki_response

    # λ§μΈν¬λν”„νΈ κ΄€λ ¨ μ§λ¬Έλ“¤
    minecraft_responses = get_minecraft_responses(text)
    if minecraft_responses:
        return minecraft_responses

    # κΈ°λ³Έ μ‘λ‹µ
    return 'μ§λ¬Έμ„ μ΄ν•΄ν•μ§€ λ»ν–μ–΄μ”. λ§μΈν¬λν”„νΈ κ΄€λ ¨ μ§λ¬Έμ„ ν•΄λ³΄μ‹κ±°λ‚ λ‹¤λ¥Έ ν‘ν„μΌλ΅ μ§λ¬Έν•΄ μ£Όμ„Έμ”.'


def search_wiki_content(query):
    """μ„ν‚¤μ—μ„ κ΄€λ ¨ λ¬Έμ„λ¥Ό κ²€μƒ‰ν•κ³  λ‹µλ³€ μƒμ„±"""
    try:
        # μ λ©μ—μ„ κ²€μƒ‰
        pages = WikiPage.objects.filter(title__icontains=query)[:3]
        
        if not pages:
            # λ‚΄μ©μ—μ„ κ²€μƒ‰
            pages = WikiPage.objects.filter(content__icontains=query)[:3]
        
        if not pages:
            # νƒκ·Έμ—μ„ κ²€μƒ‰
            pages = WikiPage.objects.filter(tags__icontains=query)[:3]

        if pages:
            response = f"'{query}'μ— λ€ν• μ •λ³΄λ¥Ό μ°Ύμ•μµλ‹λ‹¤:\n\n"
            
            for page in pages:
                # μ”μ•½μ΄ μμΌλ©΄ μ‚¬μ©, μ—†μΌλ©΄ λ‚΄μ©μ μ²« 100μ
                summary = page.summary or page.content[:100] + "..."
                response += f"π“– **{page.title}**\n"
                response += f"{summary}\n"
                response += f"π”— μμ„Έν λ³΄κΈ°: /wiki/{page.title}/\n\n"
            
            return response
            
    except Exception as e:
        print(f"Wiki search error: {e}")
    
    return None


def get_minecraft_responses(text):
    """λ§μΈν¬λν”„νΈ κ΄€λ ¨ μΌλ°μ μΈ μ§λ¬Έμ— λ€ν• λ‹µλ³€"""
    lower = text.lower()
    
    # κ΄‘λ¬Ό κ΄€λ ¨
    if any(ore in lower for ore in ['λ‹¤μ΄μ•„λ¬λ“', 'λ‹¤μ΄μ•„', 'diamond']):
        return '''π’ **λ‹¤μ΄μ•„λ¬λ“**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
λ‹¤μ΄μ•„λ¬λ“λ” λ§μΈν¬λν”„νΈμ—μ„ κ°€μ¥ κ·€μ¤‘ν• κ΄‘λ¬Ό μ¤‘ ν•λ‚μ…λ‹λ‹¤.

π“ **νλ“ λ°©λ²•:**
- YμΆν‘ 16 μ΄ν•μ—μ„ λ°κ²¬
- μ²  κ³΅κ΄­μ΄ μ΄μƒ ν•„μ”
- μƒμ„± ν™•λ¥ : λ§¤μ° λ‚®μ (0.1%)

π”§ **μ©λ„:**
- λ‹¤μ΄μ•„λ¬λ“ λ„κµ¬ μ μ‘
- λ‹¤μ΄μ•„λ¬λ“ κ°‘μ· μ μ‘
- μΈμ±νΈ ν…μ΄λΈ” μ μ‘

π“– μμ„Έν• μ •λ³΄: /wiki/λ‹¤μ΄μ•„λ¬λ“/'''

    if any(ore in lower for ore in ['μ² ', 'iron']):
        return '''β›οΈ **μ²  κ΄‘μ„**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
μ²  κ΄‘μ„μ€ λ§μΈν¬λν”„νΈμ—μ„ κ°€μ¥ μ μ©ν• κ΄‘λ¬Ό μ¤‘ ν•λ‚μ…λ‹λ‹¤.

π“ **νλ“ λ°©λ²•:**
- YμΆν‘ 64 μ΄ν•μ—μ„ λ°κ²¬
- λ κ³΅κ΄­μ΄ μ΄μƒ ν•„μ”
- μƒμ„± ν™•λ¥ : λ†’μ (1.3%)

π”§ **μ©λ„:**
- μ² κ΄΄ μ μ‘ (μ λ ¨ ν•„μ”)
- μ²  λ„κµ¬ λ° κ°‘μ· μ μ‘
- λ μΌ μ μ‘

π“– μμ„Έν• μ •λ³΄: /wiki/μ²  κ΄‘μ„/'''

    if any(ore in lower for ore in ['μ²­κΈμ„', 'lapis', 'μ²­κΈ']):
        return '''π’™ **μ²­κΈμ„**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
μ²­κΈμ„μ€ λ§μΈν¬λν”„νΈμ—μ„ μΈμ±νΈμ— μ‚¬μ©λλ” μ¤‘μ”ν• κ΄‘λ¬Όμ…λ‹λ‹¤.

π“ **νλ“ λ°©λ²•:**
- YμΆν‘ 64 μ΄ν•μ λ™κµ΄μ—μ„ λ°κ²¬
- λ κ³΅κ΄­μ΄ μ΄μƒ ν•„μ”
- κ΄‘λ§¥λ‹Ή 4-8κ° μƒμ„±

π”§ **μ©λ„:**
- μΈμ±νΈ ν…μ΄λΈ”μ—μ„ μΈμ±νΈ λ λ²¨ μ†λ¨
- μ²­κΈμ„ λΈ”λ΅ μ μ‘
- νλ€μƒ‰ μ—Όλ£ μ μ‘

π“– μμ„Έν• μ •λ³΄: /wiki/μ²­κΈμ„/'''

    # μΈμ±νΈ κ΄€λ ¨
    if any(ench in lower for ench in ['μΈμ±νΈ', 'enchant']):
        return '''β¨ **μΈμ±νΈ**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
μΈμ±νΈλ” λ§μΈν¬λν”„νΈμ—μ„ λ„κµ¬μ™€ κ°‘μ·μ— νΉλ³„ν• λ¥λ ¥μ„ λ¶€μ—¬ν•λ” μ‹μ¤ν…μ…λ‹λ‹¤.

π”® **μΈμ±νΈ ν…μ΄λΈ”:**
- μ±… 1κ° + λ‹¤μ΄μ•„λ¬λ“ 2κ° + ν‘μ”μ„ 4κ°λ΅ μ μ‘
- μµλ€ 30λ λ²¨κΉμ§€ μ‚¬μ© κ°€λ¥
- μ²­κΈμ„μΌλ΅ λ λ²¨ μ†λ¨

β”οΈ **μ£Όμ” μΈμ±νΈ:**
- ν¨μ¨μ„±: μ±„κµ΄ μ†λ„ μ¦κ°€
- λ‚ μΉ΄λ΅μ›€: κ³µκ²©λ ¥ μ¦κ°€
- λ³΄νΈ: λ¨λ“  ν”Όν•΄ κ°μ†

π“– μμ„Έν• μ •λ³΄: /wiki/μΈμ±νΈ/'''

    # μ–‘μ΅° κ΄€λ ¨
    if any(brew in lower for brew in ['μ–‘μ΅°', 'ν¬μ…', 'potion']):
        return '''π§ **μ–‘μ΅°**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
μ–‘μ΅°λ” λ§μΈν¬λν”„νΈμ—μ„ λ¬Όμ•½μ„ μ μ‘ν•λ” μ‹μ¤ν…μ…λ‹λ‹¤.

β—οΈ **μ–‘μ΅°κΈ°:**
- ν™”μ—Ό κ°€λ£¨ + λ§‰λ€κΈ° 3κ°λ΅ μ μ‘
- λ„¤λ” μ‚¬λ§κ·€ + λ¬Όλ³‘μΌλ΅ κ±°μΉ λ¬Όμ•½ μ μ‘

π’ **μ£Όμ” λ¬Όμ•½:**
- ν: λΈ”λ μ΄μ¦ κ°€λ£¨ + κ±°μΉ λ¬Όμ•½
- μ‹ μ†: μ„¤νƒ• + κ±°μΉ λ¬Όμ•½
- μ ν”„: ν† λΌμ λ° + κ±°μΉ λ¬Όμ•½

π“– μμ„Έν• μ •λ³΄: /wiki/μ–‘μ΅°/'''

    # λΉ κ΄€λ ¨
    if any(mob in lower for mob in ['ν¬λ¦¬νΌ', 'creeper']):
        return '''π’¥ **ν¬λ¦¬νΌ**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
ν¬λ¦¬νΌλ” λ§μΈν¬λν”„νΈμ λ€ν‘μ μΈ μ λ€μ  λΉμ…λ‹λ‹¤.

β οΈ **νΉμ§•:**
- ν”λ μ΄μ–΄ κ·Όμ²μ—μ„ ν­λ°
- "μ‰Ώ" μ†λ¦¬λ΅ κ²½κ³ 
- ν­λ°λ΅ λΈ”λ΅ νκ΄΄ λ° ν”Όν•΄

π― **λ€μ²λ²•:**
- 3λΈ”λ΅ μ΄μƒ κ±°λ¦¬ μ μ§€
- ν™λ΅ μ›κ±°λ¦¬ κ³µκ²©
- λΉ λ¥΄κ² λ„λ§κ°€κΈ°

π“– μμ„Έν• μ •λ³΄: /wiki/ν¬λ¦¬νΌ/'''

    # λ„κµ¬ κ΄€λ ¨
    if any(tool in lower for tool in ['λ„κµ¬', 'tool', 'κ³΅κ΄­μ΄', 'pickaxe']):
        return '''π› οΈ **λ„κµ¬**μ— λ€ν•΄ μ•λ ¤λ“λ¦΄κ²μ”!
        
λ§μΈν¬λν”„νΈμ—λ” λ‹¤μ–‘ν• λ„κµ¬λ“¤μ΄ μμµλ‹λ‹¤.

β›οΈ **κ³΅κ΄­μ΄:**
- λ‚λ¬΄: 59ν μ‚¬μ©
- λ: 131ν μ‚¬μ©
- μ² : 250ν μ‚¬μ©
- λ‹¤μ΄μ•„λ¬λ“: 1,561ν μ‚¬μ©

β”οΈ **κ²€:**
- λ‚λ¬΄: 59ν μ‚¬μ©
- λ: 131ν μ‚¬μ©
- μ² : 250ν μ‚¬μ©
- λ‹¤μ΄μ•„λ¬λ“: 1,561ν μ‚¬μ©

π“– μμ„Έν• μ •λ³΄: /wiki/λ„κµ¬/'''

    return None
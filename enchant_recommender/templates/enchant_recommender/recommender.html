<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì¸í¬ë˜í”„íŠ¸ ì¸ì±ˆíŠ¸ ì¶”ì²œê¸°</title>
    {% load static %}
    {% load enchant_filters %} {# ìƒˆë¡œ ì¶”ê°€í•œ ì»¤ìŠ¤í…€ í•„í„° ë¡œë“œ #}
    <style>
        body { font-family: 'Minecraft', Arial, sans-serif; padding: 20px; background-color: #c6c6c6; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #FFF; background-color: #585858; padding: 10px; border: 2px solid #363636; box-shadow: inset 0 0 0 2px #a0a0a0; }
        .controls { margin-bottom: 20px; padding: 15px; background-color: #8b8b8b; border: 2px solid #363636; box-shadow: inset 0 0 0 2px #a0a0a0; display: flex; gap: 10px; align-items: center; }
        .controls label { font-weight: bold; color: #202020;}
        .controls select, .controls button {
            padding: 8px; font-family: inherit; font-size: 14px;
            background-color: #c6c6c6; border: 2px solid #363636;
            box-shadow: inset 0 0 0 2px #ffffff, 0 3px 0 #585858;
        }
        .controls button:active { box-shadow: inset 0 0 0 2px #ffffff, 0 1px 0 #585858; transform: translateY(2px); }

        .category-columns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;}
        .category-column {
            min-height: 300px; /* ë“œë˜ê·¸ ì˜ì—­ í™•ë³´ */
            background-color: #8b8b8b; border: 2px solid #363636; padding: 10px;
            box-shadow: inset 0 0 0 2px #a0a0a0;
        }
        .category-title {
            text-align: center; font-weight: bold; margin-bottom: 10px; padding: 8px;
            background-color: #585858; color: white; border: 2px solid #363636;
            box-shadow: inset 0 0 0 2px #a0a0a0;
        }
        .enchant-item {
            background-color: #c6c6c6; border: 2px solid #363636; padding: 8px; margin-bottom: 8px;
            display: flex; align-items: center; cursor: grab;
            box-shadow: inset 0 0 0 2px #ffffff, 0 2px 0 #585858;
        }
        .enchant-item img { width: 24px; height: 24px; margin-right: 8px; image-rendering: pixelated; }
        .enchant-item .name { font-weight: bold; flex-grow: 1; color: #202020;}
        .enchant-item .actions button {
            font-size: 10px; padding: 2px 4px; margin-left: 3px;
            background-color: #a0a0a0; border: 1px solid #363636;
            box-shadow: inset 0 0 0 1px #ffffff, 0 1px 0 #585858;
        }
         .enchant-item .actions button:active { transform: translateY(1px); box-shadow: inset 0 0 0 1px #ffffff, 0 0px 0 #585858;}


        .message-area { padding: 10px; margin-top:10px; text-align: center; border: 2px solid #363636; font-weight: bold; color:white; }
        .message-area.info { background-color: #6b996b; }
        .message-area.error { background-color: #c47171; }

        /* For drag and drop later */
        .dragging { opacity: 0.5; background-color: #e0e0e0; }
        .drop-target-hover { background-color: #a0d0a0 !important; } /* ì¹´í…Œê³ ë¦¬ ì»¬ëŸ¼ í˜¸ë²„ íš¨ê³¼ */

        .save-panel {
            margin-top: 24px;
            padding: 20px;
            background-color: #8b8b8b;
            border: 2px solid #363636;
            box-shadow: inset 0 0 0 2px #a0a0a0;
        }
        .save-panel label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #202020;
        }
        .save-panel input[type="text"],
        .save-panel textarea {
            width: 100%;
            padding: 10px;
            font-family: inherit;
            border: 2px solid #363636;
            background-color: #c6c6c6;
            box-shadow: inset 0 0 0 2px #ffffff;
            margin-bottom: 14px;
        }
        .save-panel textarea { min-height: 120px; resize: vertical; }
        .save-panel .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .save-panel button {
            padding: 10px 16px;
            font-weight: bold;
            background-color: #a0d0a0;
            border: 2px solid #363636;
            box-shadow: inset 0 0 0 2px #ffffff, 0 3px 0 #585858;
        }
        .save-panel button:active {
            box-shadow: inset 0 0 0 2px #ffffff, 0 1px 0 #585858;
            transform: translateY(2px);
        }
        .save-panel .auth-notice {
            padding: 10px;
            background-color: #c47171;
            border: 2px solid #363636;
            box-shadow: inset 0 0 0 2px #ffffff;
            color: #fff;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì¸ì±ˆíŠ¸ ì¶”ì²œê¸°: <span id="selectedItemNameDisplay">{{ selected_item_name }}</span></h1>
             <a href="{% url 'enchant_recommender:main' %}" class="mc-btn mt-2" style="background-color: #a0a0a0;">â† ë©”ì¸ìœ¼ë¡œ</a>
            <a href="{% url 'enchant_recommender:main' %}" class="btn btn-outline-secondary btn-sm mt-2">â† ì¸ì±ˆíŠ¸ ê²Œì‹œíŒìœ¼ë¡œ</a>
        </div>

        {% if message %}
            <div class="message-area {% if 'ì˜ëª»ëœ' in message or 'ì—†ìŠµë‹ˆë‹¤' in message or 'ì˜¤ë¥˜' in message %}error{% else %}info{% endif %}">
                {{ message }}
            </div>
        {% endif %}

        <div class="controls">
            <form method="post" style="display:inline-flex; align-items:center; gap:10px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="select_item_type">
                <label for="item_type_select">ì¥ë¹„ ì„ íƒ:</label>
                <select name="item_type" id="item_type_select" onchange="this.form.submit()">
                    {% for type_id, type_name in item_types.items %}
                        <option value="{{ type_id }}" {% if selected_item_type == type_id %}selected{% endif %}>{{ type_name }}</option>
                    {% endfor %}
                </select>
            </form>
            <form method="post" style="margin-left: auto;">
                 {% csrf_token %}
                <input type="hidden" name="action" value="reset_all">
                <button type="submit">ëª¨ë“  ë¶„ë¥˜ ì´ˆê¸°í™”</button>
            </form>
        </div>

        <div class="save-panel">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="save_recommendation">

                <label for="title_input">ì¶”ì²œ ì œëª©</label>
                <input type="text" id="title_input" name="title_content" value="{{ temp_title }}" placeholder="ì˜ˆ: ë‹¤ì´ì•„ ê²€ PvE ì„¸íŒ…" required>

                <label for="memo_input">ë©”ëª¨ / ì„¸ë¶€ ì „ëµ</label>
                <textarea id="memo_input" name="memo_content" placeholder="ì¶”ì²œ ì´ìœ ë‚˜ ìš´ìš© íŒì„ ì ì–´ì£¼ì„¸ìš”.">{{ temp_memo }}</textarea>

                <div class="actions">
                    <button type="submit" {% if not user.is_authenticated %}disabled{% endif %}>ğŸ’¾ ì¶”ì²œ ì €ì¥</button>
                    {% if not user.is_authenticated %}
                        <div class="auth-notice">ë¡œê·¸ì¸ í›„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="category-columns">
            <!-- ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì±ˆíŠ¸ (í˜„ì¬ ì•„ì´í…œì— ì ìš© ê°€ëŠ¥í•˜ê³  ì•„ì§ ë¶„ë¥˜ ì•ˆëœ ê²ƒ) -->
            <div class="category-column available-enchants" id="available-column" data-category="available">
                <div class="category-title">ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì±ˆíŠ¸</div>
                {% for enchant_id, enchant_data in available_enchants.items %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                        <div class="actions">
                            <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="recommended"><button type="submit" title="ì¶”ì²œìœ¼ë¡œ ì´ë™">ì¶”ì²œ</button></form>
                            <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="general"><button type="submit" title="ì¼ë°˜ìœ¼ë¡œ ì´ë™">ì¼ë°˜</button></form>
                            <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="not_recommended"><button type="submit" title="ë¹„ì¶”ì²œìœ¼ë¡œ ì´ë™">ë¹„ì¶”</button></form>
                        </div>
                    </div>
                {% empty %}
                    <p style="text-align:center; color:#505050;">ì ìš© ê°€ëŠ¥í•œ ì¸ì±ˆíŠ¸ê°€ ì—†ê±°ë‚˜ ëª¨ë‘ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            </div>

            <!-- ì¶”ì²œ ì¸ì±ˆíŠ¸ -->
            <div class="category-column recommended-enchants" id="recommended-column" data-category="recommended">
                <div class="category-title">ì¶”ì²œ ì¸ì±ˆíŠ¸ (Sê¸‰)</div>
                {% for enchant_id in recommended_enchants_ids %}
                    {% with enchant_data=all_enchants_data|get_item:enchant_id %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                        <div class="actions">
                             <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="available"><button type="submit" title="ëª©ë¡ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ì œê±°</button></form>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>

            <!-- ì¼ë°˜ ì¸ì±ˆíŠ¸ -->
            <div class="category-column general-enchants" id="general-column" data-category="general">
                <div class="category-title">ì¼ë°˜ ì¸ì±ˆíŠ¸ (A/Bê¸‰)</div>
                {% for enchant_id in general_enchants_ids %}
                     {% with enchant_data=all_enchants_data|get_item:enchant_id %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                         <div class="actions">
                             <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="available"><button type="submit" title="ëª©ë¡ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ì œê±°</button></form>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>

            <!-- ë¹„ì¶”ì²œ ì¸ì±ˆíŠ¸ -->
            <div class="category-column not-recommended-enchants" id="not-recommended-column" data-category="not_recommended">
                <div class="category-title">ë¹„ì¶”ì²œ ì¸ì±ˆíŠ¸ (Cê¸‰/ì €ì£¼)</div>
                {% for enchant_id in not_recommended_enchants_ids %}
                    {% with enchant_data=all_enchants_data|get_item:enchant_id %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                         <div class="actions">
                             <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="available"><button type="submit" title="ëª©ë¡ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ì œê±°</button></form>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
        </div>
    </div>

    </div>

    {# ë”•ì…”ë„ˆë¦¬ í‚¤ë¡œ ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ì»¤ìŠ¤í…€ í…œí”Œë¦¿ í•„í„° ë¡œë“œ (í•„ìš”ì‹œ) #}
    {# {% load custom_filters %} #}
    {# `all_enchants_data|get_item:enchant_id`ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìš”. ì—†ë‹¤ë©´ views.pyì—ì„œ context ë§Œë“¤ ë•Œ ì§ì ‘ ê°ì²´ë¡œ ë³€í™˜ #}
    {# ë§Œì•½ get_item í•„í„°ê°€ ì—†ë‹¤ë©´, views.pyì—ì„œ ê° ID ë¦¬ìŠ¤íŠ¸ë¥¼ ê°ì²´ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ì„œ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤. #}
    {# ì˜ˆ: recommended_enchants = [ENCHANTMENTS[id] for id in recommended_enchants_ids] #}
    {# ê·¸ë¦¬ê³  í…œí”Œë¦¿ì—ì„œëŠ” {% for enchant_data in recommended_enchants %} ë¡œ ì‚¬ìš© #}

    <script>
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ JavaScript (ê¸°ë³¸ í‹€ - ì‹¤ì œ ê¸°ëŠ¥ì€ ì¶”ê°€ êµ¬í˜„ í•„ìš”)
        document.addEventListener('DOMContentLoaded', () => {
            const enchantItems = document.querySelectorAll('.enchant-item');
            const categoryColumns = document.querySelectorAll('.category-column');
            let draggedItem = null;

            enchantItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    setTimeout(() => item.classList.add('dragging'), 0);
                    // e.dataTransfer.setData('text/plain', item.dataset.enchantId); // ë°ì´í„° ì „ë‹¬ (í•„ìš”ì‹œ)
                });

                item.addEventListener('dragend', () => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });
            });

            categoryColumns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ë“œë¡­ í—ˆìš©)
                    column.classList.add('drop-target-hover');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drop-target-hover');
                });

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drop-target-hover');
                    if (draggedItem) {
                        // draggedItemì„ ì´ columnìœ¼ë¡œ ì˜®ê¸°ëŠ” ë¡œì§ (í™”ë©´ìƒ)
                        // column.appendChild(draggedItem); // ë‹¨ìˆœíˆ DOM ì´ë™ (ë°±ì—”ë“œ ì—°ë™ X)

                        // ì‹¤ì œë¡œëŠ” formì„ ë§Œë“¤ì–´ì„œ submit í•´ì•¼ í•¨
                        const enchantId = draggedItem.dataset.enchantId;
                        const targetCategory = column.dataset.category;

                        // ìˆ¨ê²¨ì§„ í¼ì„ ë™ì ìœ¼ë¡œ ë§Œë“¤ì–´ ì œì¶œ
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = ''; // í˜„ì¬ í˜ì´ì§€ë¡œ POST

                        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

                        form.innerHTML = `
                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                            <input type="hidden" name="action" value="move_enchant">
                            <input type="hidden" name="enchant_id" value="${enchantId}">
                            <input type="hidden" name="target_category" value="${targetCategory}">
                        `;
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    </script>
</body>
</html>

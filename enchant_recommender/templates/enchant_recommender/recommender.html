<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì¸í¬ë˜í”„íŠ¸ ì¸ì±ˆíŠ¸ ì¶”ì²œê¸°</title>
    {% load static %}
    {% load custom_filters %}
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mc-dark: #363636;
            --mc-medium: #585858;
            --mc-light: #c6c6c6;
            --mc-white: #ffffff;
            --mc-green: #6b996b;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 20px;
            background-color: var(--mc-light);
            color: var(--mc-dark);
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: var(--mc-light);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--mc-medium);
            border: 2px solid var(--mc-dark);
            box-shadow: 4px 4px 0 var(--mc-dark);
        }
        .header h1 {
            color: var(--mc-white);
            font-size: 2em;
            text-shadow: 2px 2px 0 var(--mc-dark);
            margin: 0 0 10px 0;
        }
        /* ê³µí†µ ë²„íŠ¼/ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .mc-control, .mc-btn {
            padding: 8px 15px; font-family: inherit; font-size: 14px;
            background-color: var(--mc-light);
            border: 2px solid var(--mc-dark);
            box-shadow: inset 0 0 0 2px var(--mc-white), 0 3px 0 var(--mc-medium); /* í”½ì…€ ê·¸ë¦¼ì íš¨ê³¼ */
            color: var(--mc-dark);
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .mc-btn:active {
            box-shadow: inset 0 0 0 2px var(--mc-white), 0 1px 0 var(--mc-medium);
            transform: translateY(2px);
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--mc-light);
            border: 2px solid var(--mc-dark);
            box-shadow: 4px 4px 0 var(--mc-medium);
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .controls label { font-weight: bold; color: var(--mc-dark);}

        .save-form-panel {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--mc-medium);
            border: 2px solid var(--mc-dark);
            box-shadow: 4px 4px 0 var(--mc-dark);
        }

        .category-columns {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .category-column {
            min-height: 300px;
            background-color: var(--mc-light);
            border: 2px solid var(--mc-dark);
            padding: 10px;
            box-shadow: inset 0 0 0 2px var(--mc-medium);
        }
        .category-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--mc-dark);
            color: var(--mc-white);
            border: 2px solid var(--mc-medium);
        }
        .enchant-item {
            background-color: var(--mc-white);
            border: 2px solid var(--mc-dark);
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            cursor: grab;
            box-shadow: 2px 2px 0 var(--mc-medium);
        }
        .enchant-item .actions button {
            font-size: 10px;
            padding: 2px 4px;
            margin-left: 3px;
            /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
            background-color: var(--mc-light);
            border: 1px solid var(--mc-dark);
            box-shadow: inset 0 0 0 1px var(--mc-white), 0 1px 0 var(--mc-medium);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì¸ì±ˆíŠ¸ ì¶”ì²œê¸°: <span id="selectedItemNameDisplay">{{ selected_item_name }}</span></h1>
             <a href="{% url 'enchant_recommender:main' %}" class="mc-btn mt-2" style="background-color: #a0a0a0;">â† ë©”ì¸ìœ¼ë¡œ</a>
        </div>

        {% if message %}
            <div class="message-area {% if 'ì˜ëª»ëœ' in message or 'ì—†ìŠµë‹ˆë‹¤' in message or 'ì˜¤ë¥˜' in message %}error{% else %}info{% endif %}">
                {{ message }}
            </div>
        {% endif %}

       <form method="post" action="{% url 'enchant_recommender:recommender' %}" class="save-form-panel">
            {% csrf_token %}
            <input type="hidden" name="action" value="save_recommendation">

            <div style="margin-bottom: 10px;">
                <label for="title_content" style="font-weight: bold; color: var(--mc-white);">ê²Œì‹œë¬¼ ì œëª©:</label>
                <input type="text" id="title_content" name="title_content" required
                       style="width: 100%; padding: 5px; border: 1px solid var(--mc-dark);"
                       placeholder="ì˜ˆ: ìµœê°• PVE ë‹¤ì´ì•„ëª¬ë“œ ê²€ ì¸ì±ˆíŠ¸" value="{{ temp_title }}">
            </div>

            <div style="margin-bottom: 15px;">
                <label for="memo_content" style="font-weight: bold; color: var(--mc-white);">ë©”ëª¨ (ì„ íƒ ì‚¬í•­):</label>
                <textarea id="memo_content" name="memo_content" rows="3"
                          style="width: 100%; padding: 5px; border: 1px solid var(--mc-dark);">{{ temp_memo }}</textarea>
            </div>

            <button type="submit" class="mc-btn" style="background-color: var(--mc-green);">
                <i class="fas fa-save"></i> ì¶”ì²œ ì‘ì„± ì™„ë£Œ ë° ì €ì¥
            </button>
        </form>

        <div class="controls">
            <form method="post" style="display:inline-flex; align-items:center; gap:10px; margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="action" value="select_item_type">
                <label for="item_type_select">ì¥ë¹„ ì„ íƒ:</label>
                <select name="item_type" id="item_type_select" onchange="this.form.submit()" class="mc-control">
                    {% for type_id, type_name in item_types.items %}
                        <option value="{{ type_id }}" {% if selected_item_type == type_id %}selected{% endif %}>
                            {{ type_name }}
                        </option>
                    {% endfor %}
                </select>
            </form>

            <form method="post" action="{% url 'enchant_recommender:new_recommender' %}" style="margin-left: auto;">
                 {% csrf_token %}
                <button type="submit" class="mc-btn" style="background-color: #d15151;">ìƒˆ ì¶”ì²œ ì‹œì‘ (ì „ì²´ ì´ˆê¸°í™”)</button>
            </form>
        </div>

        <div class="category-columns">
            <div class="category-column available-enchants" id="available-column" data-category="available">
                <div class="category-title">ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì±ˆíŠ¸</div>
                {% for enchant_id, enchant_data in available_enchants.items %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                        <div class="actions">
                            <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="recommended"><button type="submit" title="ì¶”ì²œìœ¼ë¡œ ì´ë™">ì¶”ì²œ</button></form>
                            <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="general"><button type="submit" title="ì¼ë°˜ìœ¼ë¡œ ì´ë™">ì¼ë°˜</button></form>
                            <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="not_recommended"><button type="submit" title="ë¹„ì¶”ì²œìœ¼ë¡œ ì´ë™">ë¹„ì¶”</button></form>
                        </div>
                    </div>
                {% empty %}
                    <p style="text-align:center; color:var(--mc-dark);">ì ìš© ê°€ëŠ¥í•œ ì¸ì±ˆíŠ¸ê°€ ì—†ê±°ë‚˜ ëª¨ë‘ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            </div>

            <div class="category-column recommended-enchants" id="recommended-column" data-category="recommended">
                <div class="category-title">ì¶”ì²œ ì¸ì±ˆíŠ¸ (Sê¸‰)</div>
                {% for enchant_id in recommended_enchants_ids %}
                    {% with enchant_data=all_enchants_data|get_item:enchant_id %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                        <div class="actions">
                             <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="available"><button type="submit" title="ëª©ë¡ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ì œê±°</button></form>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>

            <div class="category-column general-enchants" id="general-column" data-category="general">
                <div class="category-title">ì¼ë°˜ ì¸ì±ˆíŠ¸ (A/Bê¸‰)</div>
                {% for enchant_id in general_enchants_ids %}
                     {% with enchant_data=all_enchants_data|get_item:enchant_id %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                         <div class="actions">
                             <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="available"><button type="submit" title="ëª©ë¡ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ì œê±°</button></form>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>

            <div class="category-column not-recommended-enchants" id="not-recommended-column" data-category="not_recommended">
                <div class="category-title">ë¹„ì¶”ì²œ ì¸ì±ˆíŠ¸ (Cê¸‰/ì €ì£¼)</div>
                {% for enchant_id in not_recommended_enchants_ids %}
                    {% with enchant_data=all_enchants_data|get_item:enchant_id %}
                    <div class="enchant-item" draggable="true" data-enchant-id="{{ enchant_id }}">
                        {% if enchant_data.icon %}<img src="{% static enchant_data.icon %}" alt="">{% endif %}
                        <span class="name">{{ enchant_data.name }}</span>
                         <div class="actions">
                             <form method="post" style="display:inline;">{% csrf_token %}<input type="hidden" name="action" value="move_enchant"><input type="hidden" name="enchant_id" value="{{ enchant_id }}"><input type="hidden" name="target_category" value="available"><button type="submit" title="ëª©ë¡ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ì œê±°</button></form>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ JavaScript (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        document.addEventListener('DOMContentLoaded', () => {
            const enchantItems = document.querySelectorAll('.enchant-item');
            const categoryColumns = document.querySelectorAll('.category-column');
            let draggedItem = null;

            enchantItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    setTimeout(() => item.classList.add('dragging'), 0);
                });

                item.addEventListener('dragend', () => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });
            });

            categoryColumns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drop-target-hover');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drop-target-hover');
                });

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drop-target-hover');
                    if (draggedItem) {
                        const enchantId = draggedItem.dataset.enchantId;
                        const targetCategory = column.dataset.category;

                        // ğŸ’¡ ì œëª©ê³¼ ë©”ëª¨ ê°’ì„ ê°€ì ¸ì™€ì„œ í•¨ê»˜ ì „ì†¡í•´ì•¼ ê°’ì´ ìœ ì§€ë¨
                        const titleContent = document.getElementById('title_content').value;
                        const memoContent = document.getElementById('memo_content').value;

                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = '';

                        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

                        form.innerHTML = `
                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                            <input type="hidden" name="action" value="move_enchant">
                            <input type="hidden" name="enchant_id" value="${enchantId}">
                            <input type="hidden" name="target_category" value="${targetCategory}">
                            <input type="hidden" name="title_content" value="${titleContent}">
                            <input type="hidden" name="memo_content" value="${memoContent}">
                        `;
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    </script>
</body>
</html>
from django.core.management.base import BaseCommand
from django.contrib.auth.models import User
from wiki.models import WikiPage, WikiCategory
import re

class Command(BaseCommand):
    help = 'Populate wiki with Minecraft data'

    def handle(self, *args, **options):
        # 관리자 사용자 생성 (없는 경우)
        admin_user, created = User.objects.get_or_create(
            username='admin',
            defaults={'email': 'admin@stevenwiki.com', 'is_staff': True, 'is_superuser': True}
        )
        if created:
            admin_user.set_password('admin123')
            admin_user.save()

        # 카테고리 생성
        categories = [
            {'name': '광물', 'description': '마인크래프트의 모든 광물', 'color': '#8B4513', 'icon': 'fas fa-gem'},
            {'name': '블록', 'description': '마인크래프트의 모든 블록', 'color': '#32CD32', 'icon': 'fas fa-cube'},
            {'name': '아이템', 'description': '마인크래프트의 모든 아이템', 'color': '#FFD700', 'icon': 'fas fa-box'},
            {'name': '몹', 'description': '마인크래프트의 모든 몹', 'color': '#FF6347', 'icon': 'fas fa-paw'},
            {'name': '인챈트', 'description': '마인크래프트의 모든 인챈트', 'color': '#9370DB', 'icon': 'fas fa-magic'},
            {'name': '양조', 'description': '마인크래프트의 양조 시스템', 'color': '#20B2AA', 'icon': 'fas fa-flask'},
            {'name': '구조물', 'description': '마인크래프트의 모든 구조물', 'color': '#A0522D', 'icon': 'fas fa-building'},
            {'name': '생물군계', 'description': '마인크래프트의 모든 생물군계', 'color': '#228B22', 'icon': 'fas fa-tree'},
        ]
        
        for cat_data in categories:
            WikiCategory.objects.get_or_create(
                name=cat_data['name'],
                defaults=cat_data
            )

        # 마인크래프트 데이터
        minecraft_data = [
            {
                'title': '청금석',
                'category': '광물',
                'content': '''# 청금석 (Lapis Lazuli)

청금석은 마인크래프트에서 **인챈트**에 사용되는 중요한 광물입니다.

## 획득 방법
- **채굴**: Y좌표 64 이하의 **동굴**에서 발견
- **생성 확률**: 청금석 광맥당 4-8개
- **도구**: 돌 곡괭이 이상 필요

## 용도
- **인챈트 테이블**에서 인챈트 레벨 소모
- **청금석 블록** 제작 (9개 청금석 필요)
- **파란색 염료** 제작

## 인챈트 레벨
- 1개 청금석 = 1 인챈트 레벨
- 최대 인챈트 레벨: 30

## 관련 문서
- [[인챈트]] - 인챈트 시스템
- [[동굴]] - 청금석이 생성되는 지형
- [[광물]] - 다른 광물들
- [[인챈트 테이블]] - 인챈트 도구''',
                'summary': '마인크래프트의 인챈트에 사용되는 청색 광물',
                'tags': '광물,인챈트,동굴,광물',
                'is_featured': True
            },
            {
                'title': '다이아몬드',
                'category': '광물',
                'content': '''# 다이아몬드 (Diamond)

다이아몬드는 마인크래프트에서 가장 귀중한 광물 중 하나입니다.

## 획득 방법
- **채굴**: Y좌표 16 이하에서 발견
- **생성 확률**: 매우 낮음 (0.1%)
- **도구**: 철 곡괭이 이상 필요

## 용도
- **다이아몬드 도구** 제작
- **다이아몬드 갑옷** 제작
- **인챈트 테이블** 제작
- **다이아몬드 블록** 제작

## 도구 내구도
- 다이아몬드 곡괭이: 1,561회
- 다이아몬드 검: 1,561회
- 다이아몬드 갑옷: 363회

## 관련 문서
- [[광물]] - 다른 광물들
- [[인챈트]] - 인챈트 시스템
- [[도구]] - 다이아몬드 도구들''',
                'summary': '마인크래프트의 가장 귀중한 광물',
                'tags': '광물,도구,갑옷,인챈트',
                'is_featured': True
            },
            {
                'title': '철 광석',
                'category': '광물',
                'content': '''# 철 광석 (Iron Ore)

철 광석은 마인크래프트에서 가장 유용한 광물 중 하나입니다.

## 획득 방법
- **채굴**: Y좌표 64 이하에서 발견
- **생성 확률**: 높음 (1.3%)
- **도구**: 돌 곡괭이 이상 필요

## 용도
- **철괴** 제작 (제련 필요)
- **철 도구** 제작
- **철 갑옷** 제작
- **철 블록** 제작
- **레일** 제작

## 제련
- 철 광석 → 철괴 (제련로 사용)
- 연료: 석탄, 목재 등

## 관련 문서
- [[광물]] - 다른 광물들
- [[제련로]] - 광물 제련
- [[도구]] - 철 도구들''',
                'summary': '마인크래프트의 가장 유용한 광물',
                'tags': '광물,도구,갑옷,제련',
                'is_featured': False
            },
            {
                'title': '인챈트',
                'category': '인챈트',
                'content': '''# 인챈트 (Enchanting)

인챈트는 마인크래프트에서 도구와 갑옷에 특별한 능력을 부여하는 시스템입니다.

## 인챈트 테이블
- **제작**: 책 1개 + 다이아몬드 2개 + 흑요석 4개
- **위치**: **인챈트 테이블** 주변에 책장 배치
- **최대 레벨**: 30

## 인챈트 레벨
- **경험치** 또는 **청금석**으로 레벨 획득
- 1개 청금석 = 1 레벨
- 최대 30레벨까지 저장 가능

## 주요 인챈트
### 도구 인챈트
- **효율성** (Efficiency): 채굴 속도 증가
- **내구성** (Unbreaking): 내구도 감소 확률 감소
- **행운** (Fortune): 광물 드롭 증가

### 무기 인챈트
- **날카로움** (Sharpness): 공격력 증가
- **화염** (Fire Aspect): 적을 불태움
- **훔치기** (Looting): 드롭 아이템 증가

### 갑옷 인챈트
- **보호** (Protection): 모든 피해 감소
- **가시** (Thorns): 공격자에게 피해
- **호흡** (Respiration): 물속에서 숨 참기

## 관련 문서
- [[청금석]] - 인챈트 레벨 소모
- [[인챈트 테이블]] - 인챈트 도구
- [[책장]] - 인챈트 레벨 증가''',
                'summary': '마인크래프트의 도구와 갑옷 강화 시스템',
                'tags': '인챈트,도구,갑옷,마법',
                'is_featured': True
            },
            {
                'title': '동굴',
                'category': '구조물',
                'content': '''# 동굴 (Cave)

동굴은 마인크래프트 지하에 생성되는 자연 구조물입니다.

## 생성 조건
- **지하** Y좌표 64 이하
- **자연 생성**: 지형 생성 시 자동 생성
- **크기**: 다양한 크기와 깊이

## 광물 생성
- **석탄**: Y좌표 128 이하
- **철**: Y좌표 64 이하
- **금**: Y좌표 32 이하
- **다이아몬드**: Y좌표 16 이하
- **청금석**: Y좌표 64 이하

## 위험 요소
- **몹 스폰**: 어두운 곳에서 몹 생성
- **용암**: 용암 호수 존재
- **낙하**: 깊은 구덩이

## 탐험 팁
- **횃불** 준비
- **도구** 준비 (곡괭이, 삽)
- **음식** 준비
- **갑옷** 착용

## 관련 문서
- [[광물]] - 동굴에서 발견되는 광물들
- [[몹]] - 동굴에서 스폰되는 몹들
- [[석탄]] - 동굴에서 가장 흔한 광물''',
                'summary': '마인크래프트 지하의 자연 구조물',
                'tags': '구조물,광물,지하,탐험',
                'is_featured': False
            },
            {
                'title': '석탄',
                'category': '광물',
                'content': '''# 석탄 (Coal)

석탄은 마인크래프트에서 가장 흔한 광물입니다.

## 획득 방법
- **채굴**: Y좌표 128 이하에서 발견
- **생성 확률**: 매우 높음 (1.0%)
- **도구**: 나무 곡괭이 이상 필요

## 용도
- **연료**: 제련, 용광로, 횃불 등
- **석탄 블록** 제작 (9개 석탄)
- **횃불** 제작 (석탄 + 막대기)

## 연료 효율
- 1개 석탄 = 8개 아이템 제련
- 석탄 블록 = 80개 아이템 제련

## 관련 문서
- [[광물]] - 다른 광물들
- [[연료]] - 연료 아이템들
- [[제련로]] - 광물 제련''',
                'summary': '마인크래프트의 가장 흔한 광물',
                'tags': '광물,연료,제련',
                'is_featured': False
            },
            {
                'title': '인챈트 테이블',
                'category': '블록',
                'content': '''# 인챈트 테이블 (Enchanting Table)

인챈트 테이블은 마인크래프트에서 인챈트를 수행하는 블록입니다.

## 제작법
- **책** 1개
- **다이아몬드** 2개  
- **흑요석** 4개

## 사용법
1. **인챈트 테이블** 우클릭
2. **아이템**을 왼쪽 슬롯에 배치
3. **청금석**으로 레벨 소모
4. **인챈트** 선택

## 레벨 증가
- **책장** 주변에 배치
- 최대 15개까지 효과
- **최대 레벨**: 30

## 관련 문서
- [[인챈트]] - 인챈트 시스템
- [[청금석]] - 인챈트 레벨 소모
- [[책장]] - 레벨 증가''',
                'summary': '마인크래프트의 인챈트 도구',
                'tags': '블록,인챈트,도구',
                'is_featured': False
            },
            {
                'title': '양조',
                'category': '양조',
                'content': '''# 양조 (Brewing)

양조는 마인크래프트에서 물약을 제작하는 시스템입니다.

## 양조기
- **제작**: 화염 가루 + 막대기 3개
- **사용법**: 양조기에 재료 넣고 양조

## 기본 재료
- **거친 물약**: 네더 사마귀 + 물병
- **두꺼운 물약**: 광석 가루 + 거친 물약
- **약한 물약**: 발광석 가루 + 거친 물약

## 물약 종류
### 즉시 회복
- **즉시 회복**: 발광석 가루 + 거친 물약
- **즉시 피해**: 발광석 가루 + 거친 물약 + 발광석 가루

### 지속 효과
- **힘**: 블레이즈 가루 + 거친 물약
- **신속**: 설탕 + 거친 물약
- **점프**: 토끼의 발 + 거친 물약

## 관련 문서
- [[양조기]] - 양조 도구
- [[물약]] - 양조 결과물
- [[네더 사마귀]] - 양조 재료''',
                'summary': '마인크래프트의 물약 제작 시스템',
                'tags': '양조,물약,마법',
                'is_featured': True
            },
            {
                'title': '크리퍼',
                'category': '몹',
                'content': '''# 크리퍼 (Creeper)

크리퍼는 마인크래프트의 대표적인 적대적 몹입니다.

## 특징
- **폭발**: 플레이어 근처에서 폭발
- **소리**: "쉿" 소리로 경고
- **피해**: 폭발로 블록 파괴 및 피해

## 행동 패턴
- **조용히 접근**: 소리 없이 다가옴
- **폭발 준비**: 1.5초간 부풀어오름
- **폭발**: 범위 내 모든 것 파괴

## 드롭 아이템
- **화약**: 폭발 시 드롭
- **음반**: 스켈레톤 화살로 죽이면 드롭

## 대처법
- **거리 유지**: 3블록 이상 떨어지기
- **공격**: 활로 원거리 공격
- **도망**: 빠르게 도망가기

## 관련 문서
- [[몹]] - 다른 몹들
- [[화약]] - 크리퍼 드롭
- [[음반]] - 특별한 드롭''',
                'summary': '마인크래프트의 폭발하는 적대적 몹',
                'tags': '몹,적대적,폭발,화약',
                'is_featured': True
            },
            {
                'title': '스켈레톤',
                'category': '몹',
                'content': '''# 스켈레톤 (Skeleton)

스켈레톤은 마인크래프트의 뼈로 된 적대적 몹입니다.

## 특징
- **원거리 공격**: 활로 화살 발사
- **뼈**: 죽으면 뼈 드롭
- **화살**: 죽으면 화살 드롭

## 행동 패턴
- **원거리 공격**: 16블록 내에서 활 사용
- **근접 공격**: 2블록 내에서 칼 사용
- **도망**: 낮에 태양을 피해 도망

## 드롭 아이템
- **뼈**: 기본 드롭
- **화살**: 0-2개 드롭
- **활**: 드물게 드롭

## 대처법
- **방패**: 화살 막기
- **근접 공격**: 빠르게 접근
- **은신**: 블록 뒤에 숨기

## 관련 문서
- [[몹]] - 다른 몹들
- [[뼈]] - 스켈레톤 드롭
- [[화살]] - 스켈레톤 드롭''',
                'summary': '마인크래프트의 뼈로 된 적대적 몹',
                'tags': '몹,적대적,뼈,화살',
                'is_featured': False
            }
        ]

        # 데이터 생성
        for data in minecraft_data:
            page, created = WikiPage.objects.get_or_create(
                title=data['title'],
                defaults={
                    'content': data['content'],
                    'category': data['category'],
                    'summary': data['summary'],
                    'tags': data['tags'],
                    'is_featured': data['is_featured'],
                    'author': admin_user
                }
            )
            
            if created:
                self.stdout.write(f"Created: {data['title']}")
            else:
                self.stdout.write(f"Already exists: {data['title']}")

        self.stdout.write(self.style.SUCCESS('Successfully populated Minecraft data!'))

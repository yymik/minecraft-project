<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입 - 스티븐 위키</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .register-container { max-width: 700px; margin: 50px auto; background-color: #fff; padding: 40px; border-radius: 0.5rem; }
        .register-header h1 { font-weight: 700; }
        .form-label { font-weight: 600; }
        .agreement-box { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 0.375rem; padding: 20px; margin-top: 25px; }
        .password-strength-bar { height: 5px; transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out; }
    </style>
</head>
<body>
<div class="register-container">
    <div class="text-center mb-4">
        <h1><a href="{% url 'main:home' %}" class="text-dark text-decoration-none">스티븐 위키</a></h1>
        <p class="text-muted">회원가입</p>
    </div>

    <div id="alertPlaceholder"></div>

    <form id="registerForm" method="post" action="{% url 'accounts:register' %}">
        {% csrf_token %}

        <!-- 아이디 -->
        <div class="mb-3">
            <label for="username" class="form-label">아이디</label>
            <input type="text" id="username" name="username" class="form-control" required>
        </div>
        
        <!-- Minecraft UUID -->
        <div class="mb-3">
            <label for="minecraft_uuid" class="form-label">Minecraft UUID</label>
            <input type="text" id="minecraft_uuid" name="minecraft_uuid" class="form-control" 
                   placeholder="Minecraft UUID를 입력하세요 (32자리 또는 하이픈 포함 36자리)" required>
            <div class="form-text">Minecraft UUID를 정확히 입력해주세요. 다른 사용자와 중복될 수 없습니다.</div>
        </div>
        
        <!-- 이메일 및 OTP 전송 버튼 -->
        <div class="mb-3">
            <label for="email" class="form-label">이메일 주소</label>
            <div class="input-group">
                <input type="email" id="email" name="email" class="form-control" placeholder="인증에 사용할 이메일을 입력하세요" required>
                <button class="btn btn-secondary" type="button" id="sendOtpBtn">OTP 전송</button>
            </div>
        </div>

        <!-- OTP 입력 + 선검증 버튼 -->
        <div class="mb-3 d-none" id="otpSection">
            <label for="otp" class="form-label">OTP 인증번호</label>
            <div class="input-group">
                <input type="text" id="otp" name="otp" class="form-control" placeholder="이메일로 받은 6자리 번호를 입력하세요">
                <button class="btn btn-outline-primary" type="button" id="verifyOtpBtn">인증하기</button>
            </div>
            <div class="form-text" id="otpHelp"></div>
        </div>

        <!-- 비밀번호 -->
        <div class="mb-3">
            <label for="password" class="form-label">비밀번호</label>
            <input type="password" id="password" name="password" class="form-control" required>
            <div class="progress" style="height: 5px; margin-top: 5px;">
                <div id="passwordStrengthBar" class="progress-bar password-strength-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"></div>
            </div>
            <div id="passwordHelp" class="form-text">영문, 숫자, 특수문자를 조합하여 8자 이상 입력해주세요.</div>
        </div>
        
        <!-- 비밀번호 확인 -->
        <div class="mb-3">
            <label for="password2" class="form-label">비밀번호 확인</label>
            <!-- name을 password2로 변경 (뷰와 일치) -->
            <input type="password" id="password2" name="password2" class="form-control" required>
            <div id="passwordConfirmHelp" class="form-text"></div>
        </div>

        <!-- 약관 동의 박스 -->
        <div class="agreement-box">
            <h5 class="fw-bold">약관 동의</h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="agree_terms" name="agree_terms" required>
                <label class="form-check-label" for="agree_terms">
                    <b>[필수]</b> <a href="/terms" target="_blank">이용약관</a> 및 <a href="/privacy" target="_blank">개인정보처리방침</a>에 동의합니다.
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="agree_ip" name="agree_ip" required>
                <label class="form-check-label" for="agree_ip">
                    <b>[필수]</b> 문서 기여 시 IP 주소가 기록되는 것에 동의합니다.
                </label>
            </div>
        </div>
        
        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">회원가입 완료</button>
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- 요소 가져오기 ---
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const emailInput = document.getElementById('email');
    const otpSection = document.getElementById('otpSection');
    const otpInput = document.getElementById('otp');
    const submitBtn = document.getElementById('submitBtn');

    const passwordInput = document.getElementById('password');
    const passwordConfirmInput = document.getElementById('password2');

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // --- 이벤트 리스너 등록 ---
    sendOtpBtn.addEventListener('click', handleSendOtpClick);
    verifyOtpBtn.addEventListener('click', handleVerifyOtpClick);
    passwordInput.addEventListener('input', updatePasswordStrength);
    passwordConfirmInput.addEventListener('input', checkPasswordMatch);

    // --- 전송(OTP) ---
    function handleSendOtpClick() {
        const email = emailInput.value.trim();
        const sendBtn = this;

        showAlert('', 'd-none'); // 이전 알림 숨기기

        if (!email.includes('@') || !email.includes('.')) {
            showAlert('유효한 이메일 주소를 입력해주세요.', 'danger');
            return;
        }

        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 전송 중...';

        fetch("{% url 'accounts:send_otp' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ email }),
        })
        .then(response => response.json())
        .then(data => {
            showAlert(data.message, data.success ? 'success' : 'danger');
            if (data.success) {
                otpSection.classList.remove('d-none');
                otpInput.focus();
            }
        })
        .catch(() => showAlert('요청 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'danger'))
        .finally(() => {
            setTimeout(() => {
                sendBtn.disabled = false;
                sendBtn.textContent = '재전송';
            }, 700);
        });
    }

    // --- 선검증(OTP) ---
    function handleVerifyOtpClick() {
        const email = emailInput.value.trim();
        const otp = otpInput.value.trim();
        if (!email || !otp) {
            showAlert('이메일과 인증번호를 모두 입력하세요.', 'danger');
            return;
        }
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 확인 중...';

        fetch("{% url 'accounts:verify_otp' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ email, otp }),
        })
        .then(res => res.json())
        .then(data => {
            showAlert(data.message, data.success ? 'success' : 'danger');
            const help = document.getElementById('otpHelp');
            help.textContent = data.message;
            help.style.color = data.success ? '#198754' : '#dc3545';

            if (data.success) {
                // 이메일/버튼 잠금, 제출 가능
                emailInput.readOnly = true;
                sendOtpBtn.disabled = true;
                verifyOtpBtn.disabled = true;
                verifyOtpBtn.classList.remove('btn-outline-primary');
                verifyOtpBtn.classList.add('btn-success');
                verifyOtpBtn.textContent = '인증 완료';
            } else {
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.textContent = '인증하기';
            }
        })
        .catch(() => {
            showAlert('인증 요청 중 오류가 발생했습니다.', 'danger');
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.textContent = '인증하기';
        });
    }

    // --- 비밀번호 강도/일치 ---
    function updatePasswordStrength() {
        const password = this.value;
        const strengthBar = document.getElementById('passwordStrengthBar');
        const helpText = document.getElementById('passwordHelp');
        let score = 0;

        if (password.length >= 8) score++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^a-zA-Z0-9]/.test(password)) score++;

        strengthBar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
        
        switch(score) {
            case 1:
            case 2:
                strengthBar.style.width = '33%';
                strengthBar.classList.add('bg-danger');
                helpText.textContent = '보안 수준: 낮음';
                helpText.style.color = '#dc3545';
                break;
            case 3:
                strengthBar.style.width = '66%';
                strengthBar.classList.add('bg-warning');
                helpText.textContent = '보안 수준: 보통';
                helpText.style.color = '#ffc107';
                break;
            case 4:
                strengthBar.style.width = '100%';
                strengthBar.classList.add('bg-success');
                helpText.textContent = '보안 수준: 높음';
                helpText.style.color = '#198754';
                break;
            default:
                strengthBar.style.width = '0%';
                helpText.textContent = '영문, 숫자, 특수문자를 조합하여 8자 이상 입력해주세요.';
                helpText.style.color = '';
        }
        checkPasswordMatch();
    }

    function checkPasswordMatch() {
        const confirmHelp = document.getElementById('passwordConfirmHelp');
        if (passwordConfirmInput.value && passwordInput.value === passwordConfirmInput.value) {
            confirmHelp.textContent = '비밀번호가 일치합니다.';
            confirmHelp.style.color = '#198754';
        } else if (passwordConfirmInput.value) {
            confirmHelp.textContent = '비밀번호가 일치하지 않습니다.';
            confirmHelp.style.color = '#dc3545';
        } else {
            confirmHelp.textContent = '';
        }
    }

    // --- 공통 알림 ---
    function showAlert(message, type) {
        const alertPlaceholder = document.getElementById('alertPlaceholder');
        if (type === 'd-none') {
            alertPlaceholder.innerHTML = '';
            return;
        }
        alertPlaceholder.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible" role="alert">`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
            '</div>'
        ].join('');
    }
});
</script>
</body>
</html>